{% extends "base.html" %}

{% block title %}2AV-Bagages - Transport de bagages rapide et sécurisé PACA{% endblock %}

{% block extra_css %}
<style>
    /* Hero Section */
    .hero {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 2rem 1rem;
        position: relative;
    }

    .hero-content {
        max-width: 1200px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4rem;
        align-items: center;
    }

    .hero-text {
        color: white;
        text-align: left;
    }

    .hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        line-height: 1.2;
    }

    .hero-subtitle {
        font-size: 1.25rem;
        margin-bottom: 2rem;
        opacity: 0.9;
        line-height: 1.6;
    }

    .hero-features {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .hero-feature {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        font-weight: 500;
    }

    .hero-cta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    /* Formulaire de réservation */
    .booking-form {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        border: 1px solid var(--glass-border);
        padding: 2.5rem;
        box-shadow: var(--shadow-heavy);
    }

    .form-step {
        display: none;
    }

    .form-step.active {
        display: block;
        animation: fadeIn 0.4s ease;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .step.active {
        background: var(--primary-color);
        transform: scale(1.1);
    }

    .step.completed {
        background: var(--success-color);
    }

    .form-title {
        text-align: center;
        color: white;
        margin-bottom: 2rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .price-display {
        background: var(--success-color);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
        margin: 1rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        animation: scaleIn 0.4s ease;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }

    /* Character mascot */
    .mascot {
        width: 200px;
        height: 200px;
        margin: 0 auto 2rem;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="80" r="40" fill="%23FFE066"/><circle cx="85" cy="75" r="5" fill="%23333"/><circle cx="115" cy="75" r="5" fill="%23333"/><path d="M85 90 Q100 100 115 90" stroke="%23333" stroke-width="3" fill="none"/><rect x="70" y="120" width="60" height="40" rx="10" fill="%234ECDC4"/><rect x="50" y="100" width="20" height="30" rx="10" fill="%23FFE066"/><rect x="130" y="100" width="20" height="30" rx="10" fill="%23FFE066"/><rect x="80" y="160" width="15" height="30" rx="7" fill="%23333"/><rect x="105" y="160" width="15" height="30" rx="7" fill="%23333"/></svg>') center/contain no-repeat;
        animation: float 3s ease-in-out infinite;
    }

    /* Services Section */
    .services {
        padding: 6rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .section-title {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin-bottom: 3rem;
    }

    .services-grid {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
    }

    .service-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        color: white;
    }

    .service-card:hover {
        transform: translateY(-10px);
        box-shadow: var(--shadow-heavy);
    }

    .service-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    .service-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    /* Pricing Section */
    .pricing {
        padding: 6rem 1rem;
    }

    .pricing-grid {
        max-width: 1000px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
    }

    .pricing-card {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        padding: 2rem;
        text-align: center;
        color: white;
        transition: all 0.3s ease;
    }

    .pricing-card:hover {
        transform: translateY(-5px) scale(1.02);
    }

    .pricing-card.featured {
        border: 2px solid var(--primary-color);
        background: rgba(78, 205, 196, 0.1);
    }

    .pricing-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--primary-color);
    }

    .pricing-price {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .pricing-features {
        list-style: none;
        margin-bottom: 2rem;
    }

    .pricing-features li {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .pricing-features li:last-child {
        border-bottom: none;
    }

    /* Contact Section */
    .contact {
        padding: 6rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
    }

    .contact-content {
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
        color: white;
    }

    .contact-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        margin-top: 3rem;
    }

    .contact-item {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        border: 1px solid var(--glass-border);
        padding: 2rem;
        transition: all 0.3s ease;
    }

    .contact-item:hover {
        transform: translateY(-5px);
    }

    .contact-icon {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }

    /* Accessibility improvements */
    .required-indicator {
        color: #FF6B6B;
        font-weight: bold;
        margin-left: 4px;
    }
    
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    
    /* Improved placeholder contrast for WCAG compliance */
    .form-input::placeholder {
        color: rgba(255, 255, 255, 0.7) !important;
        opacity: 1;
    }
    
    .form-input:focus::placeholder {
        color: rgba(0, 0, 0, 0.6) !important;
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .required-indicator {
            color: #FF4444;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.5);
        }
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .mascot {
            animation: none;
        }
        
        .step {
            transition: none;
        }
        
        .form-step.active {
            animation: none;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .hero-content {
            grid-template-columns: 1fr;
            gap: 2rem;
            text-align: center;
        }

        .hero-text {
            text-align: center;
        }

        .hero-title {
            font-size: 2.5rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .hero-cta {
            justify-content: center;
        }

        .booking-form {
            padding: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="hero-content observe">
        <div class="hero-text">
            <h1 class="hero-title">Transport rapide & sécurisé de vos bagages</h1>
            <p class="hero-subtitle">
                Service professionnel dans toute la région PACA. De votre domicile vers 
                l'aéroport, la gare, le port ou n'importe quelle destination.
            </p>
            
            <div class="hero-features">
                <div class="hero-feature">
                    <i class="fas fa-clock"></i>
                    <span>Service 7j/7</span>
                </div>
                <div class="hero-feature">
                    <i class="fas fa-shield-alt"></i>
                    <span>100% Sécurisé</span>
                </div>
                <div class="hero-feature">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Toute la PACA</span>
                </div>
            </div>
            
            <div class="hero-cta">
                <a href="#booking" class="btn btn-lg">
                    <i class="fas fa-calendar-plus"></i>
                    Réserver maintenant
                </a>
                <a href="#services" class="btn btn-outline btn-lg">
                    <i class="fas fa-info-circle"></i>
                    Nos services
                </a>
            </div>
        </div>
        
        <!-- Formulaire de réservation -->
        <div class="booking-form" id="booking" role="region" aria-labelledby="booking-title">
            <div class="mascot"></div>
            
            <form id="bookingForm" role="form" aria-labelledby="booking-title">
                <h2 id="booking-title" class="sr-only">Formulaire de réservation de transport de bagages</h2>
                <!-- Indicateur d'étapes -->
                <div class="step-indicator" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="4" aria-label="Progression du formulaire">
                    <div class="step active" data-step="1">1</div>
                    <div class="step" data-step="2">2</div>
                    <div class="step" data-step="3">3</div>
                    <div class="step" data-step="4">4</div>
                </div>
                
                <!-- Étape 1: Type de client et destination -->
                <div class="form-step active" data-step="1" role="group" aria-labelledby="step1-title">
                    <h3 id="step1-title" class="form-title">Choisissez votre profil et destination</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="client_type">Type de client <span class="required-indicator" aria-label="obligatoire">*</span></label>
                        <select class="form-input form-select" id="client_type" name="client_type" required aria-describedby="client_type_help">
                            <option value="">Sélectionnez votre profil</option>
                            <option value="individuel">Particulier individuel</option>
                            <option value="famille">Famille (3+ personnes)</option>
                            <option value="pmr">Personne à mobilité réduite</option>
                        </select>
                        <div id="client_type_help" class="sr-only">Choisissez le type qui correspond à votre situation</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="destination">Destination <span class="required-indicator" aria-label="obligatoire">*</span></label>
                        <select class="form-input form-select" id="destination" name="destination" required aria-describedby="destination_help">
                            <option value="">Où devons-nous livrer ?</option>
                            <option value="aeroport">Aéroport (Marseille Provence)</option>
                            <option value="gare">Gare (Saint-Charles, TGV...)</option>
                            <option value="port">Port de Marseille</option>
                            <option value="domicile">Adresse personnalisée</option>
                        </select>
                        <div id="destination_help" class="sr-only">Sélectionnez le lieu de livraison de vos bagages</div>
                    </div>
                </div>
                
                <!-- Étape 2: Adresse et horaire -->
                <div class="form-step" data-step="2" role="group" aria-labelledby="step2-title">
                    <h3 id="step2-title" class="form-title">Adresse de collecte et horaire</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="pickup_address">Adresse de collecte <span class="required-indicator" aria-label="obligatoire">*</span></label>
                        <input type="text" class="form-input" id="pickup_address" name="pickup_address" 
                               placeholder="123 Rue de la Paix, 13001 Marseille" required 
                               aria-describedby="pickup_address_help">
                        <div id="pickup_address_help" class="sr-only">Saisissez l'adresse complète où nous devons récupérer vos bagages</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="pickup_date">Date <span class="required-indicator" aria-label="obligatoire">*</span></label>
                            <input type="date" class="form-input" id="pickup_date" name="pickup_date" required 
                                   aria-describedby="pickup_date_help">
                            <div id="pickup_date_help" class="sr-only">Date de collecte de vos bagages</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="pickup_time">Heure <span class="required-indicator" aria-label="obligatoire">*</span></label>
                            <input type="time" class="form-input" id="pickup_time" name="pickup_time" required 
                                   aria-describedby="pickup_time_help">
                            <div id="pickup_time_help" class="sr-only">Heure de collecte de vos bagages</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="bag_count">Nombre de bagages <span class="required-indicator" aria-label="obligatoire">*</span></label>
                        <select class="form-input form-select" id="bag_count" name="bag_count" required aria-describedby="bag_count_help">
                            <option value="">Combien de bagages ?</option>
                            <option value="1">1 bagage</option>
                            <option value="2">2 bagages</option>
                            <option value="3">3 bagages</option>
                            <option value="4+">4 bagages ou plus</option>
                        </select>
                        <div id="bag_count_help" class="sr-only">Sélectionnez le nombre de bagages à transporter</div>
                    </div>
                </div>
                
                <!-- Étape 3: Informations personnelles -->
                <div class="form-step" data-step="3" role="group" aria-labelledby="step3-title">
                    <h3 id="step3-title" class="form-title">Vos informations de contact</h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="client_name">Nom complet <span class="required-indicator" aria-label="obligatoire">*</span></label>
                        <input type="text" class="form-input" id="client_name" name="client_name" 
                               placeholder="Jean Dupont" required aria-describedby="client_name_help">
                        <div id="client_name_help" class="sr-only">Saisissez votre nom et prénom complets</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="client_email">Email <span class="required-indicator" aria-label="obligatoire">*</span></label>
                            <input type="email" class="form-input" id="client_email" name="client_email" 
                                   placeholder="jean@exemple.com" required aria-describedby="client_email_help">
                            <div id="client_email_help" class="sr-only">Saisissez votre adresse email pour recevoir la confirmation</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="client_phone">Téléphone <span class="required-indicator" aria-label="obligatoire">*</span></label>
                            <input type="tel" class="form-input" id="client_phone" name="client_phone" 
                                   placeholder="06 12 34 56 78" required aria-describedby="client_phone_help">
                            <div id="client_phone_help" class="sr-only">Saisissez votre numéro de téléphone pour être contacté</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="special_instructions">Instructions spéciales (optionnel)</label>
                        <textarea class="form-input" id="special_instructions" name="special_instructions" rows="3"
                                  placeholder="Vol Air France AF1234, Terminal 2E, étage 3 sans ascenseur..." aria-describedby="special_instructions_help"></textarea>
                        <div id="special_instructions_help" class="sr-only">Informations complémentaires pour la livraison (numéro de vol, instructions d'accès, etc.)</div>
                    </div>
                </div>
                
                <!-- Étape 4: Confirmation -->
                <div class="form-step" data-step="4" role="group" aria-labelledby="step4-title">
                    <h3 id="step4-title" class="form-title">Confirmation de votre réservation</h3>
                    
                    <div id="bookingSummary" class="glass-card" style="background: rgba(255,255,255,0.1); margin-bottom: 2rem;">
                        <!-- Le résumé sera généré par JavaScript -->
                    </div>
                    
                    <div id="priceDisplay" class="price-display" style="display: none;">
                        Prix estimé: <span id="estimatedPrice">0</span>€
                    </div>
                    
                    <p style="color: rgba(255,255,255,0.8); text-align: center; margin-bottom: 2rem;">
                        En confirmant, vous acceptez que nous vous contactions sous 24h pour finaliser votre réservation.
                    </p>
                </div>
                
                <!-- Navigation -->
                <div class="form-navigation">
                    <button type="button" class="btn btn-outline" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Précédent
                    </button>
                    
                    <button type="button" class="btn" id="nextBtn" onclick="changeStep(1)">
                        Suivant <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                        <i class="fas fa-check"></i> Confirmer la réservation
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Services Section -->
<section class="services" id="services">
    <div class="observe">
        <h2 class="section-title">Nos Services</h2>
        
        <div class="services-grid">
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-plane"></i>
                </div>
                <h3 class="service-title">Transport Aéroport</h3>
                <p>Livraison directe à l'aéroport Marseille Provence. Check-in facilité, bagages sécurisés jusqu'à l'embarquement.</p>
            </div>
            
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-train"></i>
                </div>
                <h3 class="service-title">Transport Gare</h3>
                <p>Vers toutes les gares PACA : Saint-Charles, TGV, TER. Livraison aux consignes ou directement en voiture.</p>
            </div>
            
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-ship"></i>
                </div>
                <h3 class="service-title">Transport Port</h3>
                <p>Livraison au port de Marseille pour vos croisières. Service spécialisé pour les départs en bateau.</p>
            </div>
            
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-home"></i>
                </div>
                <h3 class="service-title">Livraison Domicile</h3>
                <p>Transport vers n'importe quelle adresse dans la région PACA. Service porte-à-porte personnalisé.</p>
            </div>
            
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-wheelchair"></i>
                </div>
                <h3 class="service-title">Service PMR</h3>
                <p>Service adapté aux personnes à mobilité réduite. Tarifs préférentiels et assistance personnalisée.</p>
            </div>
            
            <div class="service-card">
                <div class="service-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3 class="service-title">Sécurité Garantie</h3>
                <p>Bagages assurés, véhicules sécurisés, chauffeurs professionnels. Traçabilité complète de vos biens.</p>
            </div>
        </div>
    </div>
</section>

<!-- Pricing Section -->
<section class="pricing" id="tarifs">
    <div class="observe">
        <h2 class="section-title">Nos Tarifs</h2>
        
        <div class="pricing-grid">
            <div class="pricing-card">
                <h3 class="pricing-title">PMR</h3>
                <div class="pricing-price">À partir de 15,75€</div>
                <ul class="pricing-features">
                    <li><i class="fas fa-check"></i> Tarif préférentiel</li>
                    <li><i class="fas fa-check"></i> Assistance personnalisée</li>
                    <li><i class="fas fa-check"></i> Véhicule adapté</li>
                    <li><i class="fas fa-check"></i> Prise en charge prioritaire</li>
                </ul>
                <a href="#booking" class="btn btn-outline">Réserver</a>
            </div>
            
            <div class="pricing-card featured">
                <h3 class="pricing-title">Famille</h3>
                <div class="pricing-price">À partir de 13,75€</div>
                <ul class="pricing-features">
                    <li><i class="fas fa-check"></i> Tarif dégressif (3+ personnes)</li>
                    <li><i class="fas fa-check"></i> Véhicule spacieux</li>
                    <li><i class="fas fa-check"></i> Bagages multiples</li>
                    <li><i class="fas fa-check"></i> Service enfants inclus</li>
                </ul>
                <a href="#booking" class="btn">Réserver</a>
            </div>
            
            <div class="pricing-card">
                <h3 class="pricing-title">Individuel</h3>
                <div class="pricing-price">À partir de 17,00€</div>
                <ul class="pricing-features">
                    <li><i class="fas fa-check"></i> Service standard</li>
                    <li><i class="fas fa-check"></i> Prise en charge rapide</li>
                    <li><i class="fas fa-check"></i> Livraison garantie</li>
                    <li><i class="fas fa-check"></i> Tous types de bagages</li>
                </ul>
                <a href="#booking" class="btn btn-outline">Réserver</a>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 3rem; color: rgba(255,255,255,0.8);">
            <p><i class="fas fa-info-circle"></i> Prix calculé selon la distance et le nombre de bagages</p>
            <p><i class="fas fa-plus"></i> Suppléments destination : Aéroport +15€, Gare +8€, Port +12€, Domicile +5€</p>
        </div>
    </div>
</section>

<!-- Contact Section -->
<section class="contact" id="contact">
    <div class="contact-content observe">
        <h2 class="section-title">Contactez-nous</h2>
        <p style="font-size: 1.2rem; margin-bottom: 2rem;">
            Une question ? Une réservation urgente ? Notre équipe est à votre disposition 7j/7.
        </p>
        
        <div class="contact-info">
            <div class="contact-item">
                <div class="contact-icon">
                    <i class="fas fa-phone"></i>
                </div>
                <h3>Téléphone</h3>
                <p><strong>(+33) 6-63-49-70-64</strong></p>
                <p>Disponible 6h - 23h</p>
                <a href="tel:+33663497064" class="btn btn-sm">Appeler maintenant</a>
            </div>
            
            <div class="contact-item">
                <div class="contact-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <h3>Email</h3>
                <p><strong>2av.bagage@gmail.com</strong></p>
                <p>Réponse sous 24h garantie</p>
                <a href="mailto:2av.bagage@gmail.com" class="btn btn-sm">Envoyer un email</a>
            </div>
            
            <div class="contact-item">
                <div class="contact-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <h3>Zone de service</h3>
                <p><strong>Métropole Aix-Marseille-Provence</strong></p>
                <p>Toutes communes PACA</p>
                <a href="#booking" class="btn btn-sm">Réserver en ligne</a>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
const totalSteps = 4;

// Gestion des étapes du formulaire
function showStep(step) {
    try {
        // Masquer toutes les étapes
        document.querySelectorAll('.form-step').forEach(stepEl => {
            stepEl.classList.remove('active');
        });
        
        // Afficher l'étape actuelle avec vérification
        const activeStep = document.querySelector(`[data-step="${step}"]`);
        if (!activeStep) {
            console.error(`Étape ${step} non trouvée`);
            return;
        }
        activeStep.classList.add('active');
    
    // Mettre à jour les indicateurs
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        const stepNum = index + 1;
        stepEl.classList.remove('active', 'completed');
        
        if (stepNum === step) {
            stepEl.classList.add('active');
        } else if (stepNum < step) {
            stepEl.classList.add('completed');
        }
    });
    
    // Mettre à jour la barre de progression
    const progressBar = document.querySelector('.step-indicator');
    if (progressBar) {
        progressBar.setAttribute('aria-valuenow', step);
        progressBar.setAttribute('aria-valuetext', `Étape ${step} sur ${totalSteps}`);
    }
    
    // Gérer les boutons de navigation
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
    
    if (step === totalSteps) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-flex';
        generateSummary();
    } else {
        nextBtn.style.display = 'inline-flex';
        submitBtn.style.display = 'none';
    }
}

function changeStep(direction) {
    const newStep = currentStep + direction;
    
    if (newStep < 1 || newStep > totalSteps) return;
    
    // Validation avant de passer à l'étape suivante
    if (direction > 0 && !validateCurrentStep()) {
        return;
    }
    
    currentStep = newStep;
    showStep(currentStep);
    
    // Calcul du prix en temps réel
    if (currentStep >= 2) {
        calculatePrice();
    }
}

function validateCurrentStep() {
    try {
        const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
        if (!currentStepEl) {
            console.error(`Étape ${currentStep} non trouvée`);
            return false;
        }
        
        // Supprimer les messages d'erreur existants
        currentStepEl.querySelectorAll('.error-message').forEach(msg => msg.remove());
        
        const requiredFields = currentStepEl.querySelectorAll('[required]');
        let isValid = true;
        
        for (let field of requiredFields) {
            // Réinitialiser le style du champ
            field.style.borderColor = '';
            field.setAttribute('aria-invalid', 'false');
            
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = '#FF6B6B';
                field.setAttribute('aria-invalid', 'true');
                
                // Créer un message d'erreur accessible
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.style.cssText = 'color: #FF6B6B; font-size: 0.9rem; margin-top: 0.5rem;';
                errorMessage.setAttribute('role', 'alert');
                errorMessage.setAttribute('aria-live', 'polite');
                
                const label = currentStepEl.querySelector(`label[for="${field.id}"]`);
                const fieldName = label ? label.textContent.replace('*', '').trim() : field.name;
                errorMessage.textContent = `Le champ "${fieldName}" est obligatoire`;
                
                field.parentNode.appendChild(errorMessage);
                
                if (isValid) { // Focus seulement sur le premier champ invalide
                    field.focus();
                }
            }
        }
        
        return isValid;
    } catch (error) {
        console.error('Erreur lors du changement d'étape:', error);
        return false;
    }
}

function calculatePrice() {
    const formData = new FormData(document.getElementById('bookingForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Vérifier que les champs nécessaires sont remplis
    if (!data.client_type || !data.destination || !data.bag_count) {
        return;
    }
    
    fetch('/calculate-price', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            document.getElementById('estimatedPrice').textContent = result.price;
            document.getElementById('priceDisplay').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Erreur calcul prix:', error);
    });
}

function generateSummary() {
    const formData = new FormData(document.getElementById('bookingForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = escapeHtml(value); // Sécurisation contre XSS
    }
    
    const summaryHtml = `
        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Résumé de votre réservation</h4>
        <div style="text-align: left; color: white;">
            <p><strong>Profil :</strong> ${escapeHtml(getClientTypeLabel(data.client_type))}</p>
            <p><strong>Destination :</strong> ${escapeHtml(getDestinationLabel(data.destination))}</p>
            <p><strong>Collecte :</strong> ${data.pickup_address}</p>
            <p><strong>Date/Heure :</strong> ${formatDateTime(data.pickup_date, data.pickup_time)}</p>
            <p><strong>Bagages :</strong> ${data.bag_count}</p>
            <p><strong>Contact :</strong> ${data.client_name} - ${data.client_email}</p>
            ${data.special_instructions ? `<p><strong>Instructions :</strong> ${data.special_instructions}</p>` : ''}
        </div>
    `;
    
    document.getElementById('bookingSummary').innerHTML = summaryHtml;
    calculatePrice();
}

function getClientTypeLabel(type) {
    const labels = {
        'individuel': 'Particulier individuel',
        'famille': 'Famille (3+ personnes)',
        'pmr': 'Personne à mobilité réduite'
    };
    return labels[type] || type;
}

function getDestinationLabel(dest) {
    const labels = {
        'aeroport': 'Aéroport Marseille Provence',
        'gare': 'Gare (Saint-Charles, TGV...)',
        'port': 'Port de Marseille',
        'domicile': 'Adresse personnalisée'
    };
    return labels[dest] || dest;
}

// Fonction pour échapper le HTML et prévenir XSS
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

function formatDateTime(date, time) {
    if (!date || !time) return '';
    try {
        const dateObj = new Date(date + 'T' + time);
        if (isNaN(dateObj.getTime())) {
            return 'Date invalide';
        }
        return dateObj.toLocaleString('fr-FR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        console.error('Erreur formatage date:', error);
        return 'Date invalide';
    }
}

// Soumission du formulaire
document.getElementById('bookingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Afficher le loading
    submitBtn.innerHTML = '<div class="loading"></div> Envoi en cours...';
    submitBtn.disabled = true;
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Combiner date et heure
    data.pickup_datetime = `${data.pickup_date} ${data.pickup_time}`;
    delete data.pickup_date;
    delete data.pickup_time;
    
    fetch('/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // Succès
            document.querySelector('.booking-form').innerHTML = `
                <div style="text-align: center; color: white; padding: 2rem;">
                    <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 1rem;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Réservation confirmée !</h3>
                    <p>Numéro de réservation : <strong>#${result.booking_id}</strong></p>
                    <p>Prix estimé : <strong>${result.estimated_price}€</strong></p>
                    <p style="margin-top: 2rem; color: rgba(255,255,255,0.8);">
                        Nous vous contacterons sous 24h pour confirmer les détails.
                        Un email de confirmation vous a été envoyé.
                    </p>
                    <div style="margin-top: 2rem;">
                        <a href="/" class="btn">Nouvelle réservation</a>
                        <a href="tel:+33663497064" class="btn btn-outline" style="margin-left: 1rem;">
                            <i class="fas fa-phone"></i> Nous contacter
                        </a>
                    </div>
                </div>
            `;
        } else {
            throw new Error(result.error || 'Erreur lors de la réservation');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la réservation. Veuillez réessayer ou nous contacter directement.');
        
        // Restaurer le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Définir la date minimum à aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="pickup_date"]').min = today;
    
    // Calculer le prix en temps réel lors des changements
    document.getElementById('bookingForm').addEventListener('change', function() {
        if (currentStep >= 2) {
            setTimeout(calculatePrice, 300);
        }
    });
    
    // Gestion du scroll smooth vers le formulaire
    document.querySelectorAll('a[href="#booking"]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('booking').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });
    });
});
</script>
{% endblock %}
